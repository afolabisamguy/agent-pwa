<!DOCTYPE html>
<html>
<head>
  <base href="/agent-pwa/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="MyAgent - Your AI Assistant">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="MyAgent">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b6efd">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>MyAgent</title>

  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    #install-page { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f6f7fb; z-index: 99999; overflow: auto; }
    #install-page.active { display: flex; align-items: center; justify-content: center; padding: 24px; }
    .install-card { max-width: 480px; width: 100%; background: white; padding: 32px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    .install-card h2 { margin: 0 0 16px 0; color: #0b6efd; font-size: 24px; }
    .install-card p { line-height: 1.7; color: #333; margin: 12px 0; }
    .install-card .steps { background: #f8f9fa; padding: 16px; border-radius: 8px; margin: 20px 0; }
    .install-card .note { font-size: 14px; color: #666; margin-top: 20px; }
    .qr-code { width: 200px; height: 200px; margin: 20px auto; display: block; cursor: pointer; border-radius: 8px; }
    .link { color: #0b6efd; text-decoration: none; word-break: break-all; }
  </style>

  <!-- PRE-FLUTTER LOGIC: Detect platform and installation status -->
  <script>
    (function() {
      const PLAY_STORE_URL = "https://play.google.com/store/apps/details?id=com.myagent.app";
      
      function isAndroid() {
        return /Android/i.test(navigator.userAgent);
      }
      
      function isiOS() {
        return /iPhone|iPad|iPod/i.test(navigator.userAgent)
          || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }
      
      function isMobile() {
        return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      }

      function isInStandaloneMode() {
        return window.matchMedia('(display-mode: standalone)').matches
          || window.navigator.standalone === true;
      }

      // Determine what to show
      window.PWA_CONFIG = {
        loadFlutter: false,
        showIOSInstall: false,
        showDesktop: false,
        redirectPlayStore: false
      };

      // If already installed (standalone mode), load Flutter normally
      if (isInStandaloneMode()) {
        console.log('[PWA] Running in standalone mode - loading Flutter');
        window.PWA_CONFIG.loadFlutter = true;
        return;
      }

      // Check if explicitly wants the app (query param bypass)
      const urlParams = new URLSearchParams(window.location.search);
      // Also check if the path is just the base path (from PWA install)
      const isBasePath = window.location.pathname === '/agent-pwa/' || window.location.pathname === '/agent-pwa';
      
      if (urlParams.get('source') === 'pwa' || urlParams.get('app') === 'true' || isBasePath) {
        console.log('[PWA] Direct app request - loading Flutter');
        window.PWA_CONFIG.loadFlutter = true;
        return;
      }

      // Not installed yet - check platform
      if (isAndroid() && isMobile()) {
        console.log('[PWA] Android detected - redirecting to Play Store');
        window.PWA_CONFIG.redirectPlayStore = true;
        setTimeout(() => {
          window.location.href = PLAY_STORE_URL;
        }, 100);
        return;
      }

      if (isiOS() && isMobile()) {
        console.log('[PWA] iOS detected - showing install instructions');
        window.PWA_CONFIG.showIOSInstall = true;
        return;
      }

      if (!isMobile()) {
        console.log('[PWA] Desktop detected - showing QR code');
        window.PWA_CONFIG.showDesktop = true;
        return;
      }

      // Default fallback: load Flutter
      console.log('[PWA] Default - loading Flutter');
      window.PWA_CONFIG.loadFlutter = true;
    })();
  </script>
</head>
<body>
  <!-- Install/Redirect Page -->
  <div id="install-page">
    <div class="install-card" id="install-content"></div>
  </div>

  <script>
    // Show install page immediately if needed
    (function() {
      const installPage = document.getElementById('install-page');
      const installContent = document.getElementById('install-content');

      if (window.PWA_CONFIG.showIOSInstall) {
        installContent.innerHTML = `
          <h2>ðŸ“± Install MyAgent</h2>
          <div class="steps">
            <p><strong>1.</strong> Tap the <strong>Share button</strong> <svg width="16" height="20" fill="#0b6efd" style="vertical-align:middle; margin:0 4px"><path d="M8 0l3 3h-2v8H7V3H5l3-3zm6 8v10H2V8h2v8h8V8h2z"/></svg> in Safari</p>
            <p><strong>2.</strong> Scroll and tap <strong>"Add to Home Screen"</strong></p>
            <p><strong>3.</strong> Tap <strong>"Add"</strong> in the top right</p>
          </div>
          <p class="note">âœ¨ After installing, open MyAgent from your home screen to use the app.</p>
        `;
        installPage.classList.add('active');
      } else if (window.PWA_CONFIG.showDesktop) {
        const currentUrl = window.location.href;
        installContent.innerHTML = `
          <h2>ðŸ“± Open on Your Phone</h2>
          <p>Scan this QR code with your phone camera to install MyAgent:</p>
          <img class="qr-code" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentUrl)}" alt="QR Code" onclick="window.open('${currentUrl}', '_blank')" />
          <p style="text-align:center; font-size:14px;">Or visit:<br/><a class="link" href="${currentUrl}">${currentUrl}</a></p>
        `;
        installPage.classList.add('active');
      }
    })();
  </script>

  <!-- Load Flutter bootstrap ONLY if we should load the app -->
  <script>
    if (window.PWA_CONFIG.loadFlutter) {
      console.log('[PWA] Loading Flutter bootstrap...');
      console.log('[PWA] Current location:', window.location.href);
      console.log('[PWA] Base URL:', document.querySelector('base').href);
      
      // UNREGISTER ALL SERVICE WORKERS (temporary debug)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => {
            console.log('[PWA] UNREGISTERING service worker...');
            registration.unregister();
          });
        });
      }
      
      // Dynamically load flutter_bootstrap.js
      var script = document.createElement('script');
      script.src = 'flutter_bootstrap.js';
      script.async = true;
      script.onerror = function() {
        console.error('[PWA] FAILED to load flutter_bootstrap.js');
        console.error('[PWA] Tried to load from:', script.src);
        document.body.innerHTML = '<div style="padding:20px;font-family:sans-serif;"><h2>Debug Info</h2><p>Failed to load: ' + script.src + '</p><p>Base: ' + document.querySelector('base').href + '</p><p>Location: ' + window.location.href + '</p></div>';
      };
      script.onload = function() {
        console.log('[PWA] flutter_bootstrap.js loaded successfully!');
      };
      document.body.appendChild(script);
    } else {
      console.log('[PWA] Flutter bootstrap skipped');
    }
  </script>
</body>
</html>