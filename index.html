<!DOCTYPE html>
<html>
<head>
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="MyAgent - Your AI Assistant">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="MyAgent">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b6efd">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>MyAgent</title>

  <style>
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Monaco, monospace; 
      background: #f6f7fb;
    }
    #install-page { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: #f6f7fb; 
      z-index: 99999; 
      overflow: auto; 
    }
    #install-page.active { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 24px; 
    }
    .install-card { 
      max-width: 480px; 
      width: 100%; 
      background: white; 
      padding: 32px; 
      border-radius: 12px; 
      box-shadow: 0 4px 16px rgba(0,0,0,0.1); 
    }
    .install-card h2 { 
      margin: 0 0 16px 0; 
      color: #0b6efd; 
      font-size: 24px; 
    }
    .install-card p { 
      line-height: 1.7; 
      color: #333; 
      margin: 12px 0; 
    }
    .install-card .steps { 
      background: #f8f9fa; 
      padding: 16px; 
      border-radius: 8px; 
      margin: 20px 0; 
    }
    .install-card .note { 
      font-size: 14px; 
      color: #666; 
      margin-top: 20px; 
    }
    .qr-code { 
      width: 200px; 
      height: 200px; 
      margin: 20px auto; 
      display: block; 
      cursor: pointer; 
      border-radius: 8px; 
    }
    .link { 
      color: #0b6efd; 
      text-decoration: none; 
      word-break: break-all; 
    }
    #loading { 
      display: none; 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      text-align: center;
      color: #0b6efd;
      width: 90%;
      max-width: 400px;
    }
    #loading.active { display: block; }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0b6efd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #debug-info {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.9);
      color: #0f0;
      padding: 16px;
      font-size: 11px;
      max-height: 40vh;
      overflow: auto;
      font-family: Monaco, monospace;
      z-index: 99998;
    }
    #debug-info.active { display: block; }
    #debug-toggle {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 99999;
      cursor: pointer;
    }
    .debug-line { margin: 4px 0; }
    .debug-error { color: #f00; }
    .debug-success { color: #0f0; }
    .debug-warning { color: #ff0; }
  </style>

  <!-- PRE-FLUTTER LOGIC: Detect platform and installation status -->
  <script>
    // Debug logger
    window.DEBUG_LOGS = [];
    function debugLog(msg, type = 'info') {
      const timestamp = new Date().toISOString().substr(11, 8);
      window.DEBUG_LOGS.push({ msg, type, timestamp });
      console.log(`[PWA ${timestamp}]`, msg);
    }

    (function() {
      const PLAY_STORE_URL = "https://play.google.com/store/apps/details?id=com.myagent.app";
      
      function isAndroid() {
        return /Android/i.test(navigator.userAgent);
      }
      
      function isiOS() {
        return /iPhone|iPad|iPod/i.test(navigator.userAgent)
          || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }
      
      function isMobile() {
        return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      }

      function isInStandaloneMode() {
        const standalone = window.matchMedia('(display-mode: standalone)').matches
          || window.navigator.standalone === true;
        debugLog(`Standalone check: ${standalone}`, standalone ? 'success' : 'info');
        return standalone;
      }

      // Determine what to show
      window.PWA_CONFIG = {
        loadFlutter: false,
        showIOSInstall: false,
        showDesktop: false,
        redirectPlayStore: false
      };

      debugLog('=== PWA Detection Started ===', 'warning');
      debugLog(`User Agent: ${navigator.userAgent}`);
      debugLog(`Location: ${window.location.href}`);
      debugLog(`Pathname: ${window.location.pathname}`);
      debugLog(`Search: ${window.location.search}`);
      debugLog(`Hostname: ${window.location.hostname}`);
      debugLog(`Display Mode: ${window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser'}`);
      debugLog(`iOS Standalone: ${window.navigator.standalone}`);
      debugLog(`Is Mobile: ${isMobile()}`);
      debugLog(`Is iOS: ${isiOS()}`);
      debugLog(`Is Android: ${isAndroid()}`);

      // PRIORITY 1: If already installed (standalone mode), ALWAYS load Flutter
      if (isInStandaloneMode()) {
        debugLog('‚úì MATCH: Running in standalone mode - loading Flutter', 'success');
        window.PWA_CONFIG.loadFlutter = true;
        return;
      }

      // PRIORITY 2: Check if restored from 404 redirect
      const wasRedirected = sessionStorage.getItem('redirect');
      debugLog(`Session redirect: ${wasRedirected || 'none'}`);
      if (wasRedirected) {
        sessionStorage.removeItem('redirect');
        debugLog('‚úì MATCH: Restored from redirect - loading Flutter', 'success');
        window.PWA_CONFIG.loadFlutter = true;
        return;
      }

      // PRIORITY 3: Check URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const hasAppParam = urlParams.get('source') === 'pwa' || 
                          urlParams.get('app') === 'true';
      debugLog(`URL has app param: ${hasAppParam}`);
      
      if (hasAppParam) {
        debugLog('‚úì MATCH: App parameter detected - loading Flutter', 'success');
        window.PWA_CONFIG.loadFlutter = true;
        return;
      }

      // PRIORITY 4: Check if path indicates direct access
      const pathname = window.location.pathname;
      const isBasePath = pathname === '/' || pathname === '/index.html';
      debugLog(`Is base path: ${isBasePath}`);
      
      // If it's base path AND mobile, show appropriate action
      if (isBasePath && isMobile()) {
        // Not installed yet - check platform
        if (isAndroid()) {
          debugLog('‚úì MATCH: Android mobile - redirecting to Play Store', 'warning');
          window.PWA_CONFIG.redirectPlayStore = true;
          setTimeout(() => {
            window.location.href = PLAY_STORE_URL;
          }, 100);
          return;
        }

        if (isiOS()) {
          debugLog('‚úì MATCH: iOS mobile - showing install instructions', 'warning');
          window.PWA_CONFIG.showIOSInstall = true;
          return;
        }
      }

      // PRIORITY 5: Desktop
      if (!isMobile()) {
        debugLog('‚úì MATCH: Desktop - showing QR code', 'warning');
        window.PWA_CONFIG.showDesktop = true;
        return;
      }

      // Default fallback: load Flutter
      debugLog('‚úì MATCH: Default fallback - loading Flutter', 'success');
      window.PWA_CONFIG.loadFlutter = true;
    })();
  </script>
</head>
<body>
  <!-- Debug Toggle Button -->
  <button id="debug-toggle" onclick="document.getElementById('debug-info').classList.toggle('active')">
    üêõ Debug
  </button>

  <!-- Debug Info Panel -->
  <div id="debug-info"></div>

  <!-- Loading indicator -->
  <div id="loading">
    <div class="spinner"></div>
    <p>Loading MyAgent...</p>
    <p style="font-size: 12px; color: #666;">Tap üêõ Debug below for details</p>
  </div>

  <!-- Install/Redirect Page -->
  <div id="install-page">
    <div class="install-card" id="install-content"></div>
  </div>

  <script>
    // Render debug logs
    function renderDebugLogs() {
      const debugDiv = document.getElementById('debug-info');
      debugDiv.innerHTML = window.DEBUG_LOGS.map(log => {
        const className = `debug-line debug-${log.type}`;
        return `<div class="${className}">[${log.timestamp}] ${log.msg}</div>`;
      }).join('');
    }

    // Update debug logs every second
    setInterval(renderDebugLogs, 1000);

    // Show install page immediately if needed
    (function() {
      const installPage = document.getElementById('install-page');
      const installContent = document.getElementById('install-content');
      const loading = document.getElementById('loading');

      if (window.PWA_CONFIG.showIOSInstall) {
        installContent.innerHTML = `
          <h2>üì± Install MyAgent</h2>
          <p>To use MyAgent as a native app on your iPhone:</p>
          <div class="steps">
            <p><strong>1.</strong> Tap the <strong>Share button</strong> <svg width="16" height="20" fill="#0b6efd" style="vertical-align:middle; margin:0 4px"><path d="M8 0l3 3h-2v8H7V3H5l3-3zm6 8v10H2V8h2v8h8V8h2z"/></svg> in Safari (at the bottom)</p>
            <p><strong>2.</strong> Scroll down and tap <strong>"Add to Home Screen"</strong></p>
            <p><strong>3.</strong> Tap <strong>"Add"</strong> in the top right corner</p>
          </div>
          <p class="note">‚ú® After installing, open MyAgent from your home screen to start using the app.</p>
        `;
        installPage.classList.add('active');
        debugLog('Showing iOS install instructions', 'success');
      } else if (window.PWA_CONFIG.showDesktop) {
        const currentUrl = window.location.href;
        const qrUrl = currentUrl.includes('?') ? currentUrl : currentUrl + '?source=pwa';
        installContent.innerHTML = `
          <h2>üì± Open on Your Phone</h2>
          <p>MyAgent is designed for mobile devices. Scan this QR code with your phone camera:</p>
          <img class="qr-code" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrUrl)}" alt="QR Code" onclick="window.open('${qrUrl}', '_blank')" />
          <p style="text-align:center; font-size:14px; margin-top:20px;">Or open this link on your phone:<br/><a class="link" href="${qrUrl}" target="_blank">${window.location.hostname}</a></p>
          <p class="note">üí° Tip: After opening on your phone, you can install it as an app!</p>
        `;
        installPage.classList.add('active');
        debugLog('Showing desktop QR code', 'success');
      } else if (window.PWA_CONFIG.redirectPlayStore) {
        installContent.innerHTML = `
          <h2>üì± Redirecting...</h2>
          <p>Taking you to the Play Store to install MyAgent...</p>
          <div class="spinner" style="margin: 20px auto;"></div>
        `;
        installPage.classList.add('active');
        debugLog('Redirecting to Play Store', 'warning');
      }
    })();
  </script>

  <!-- Load Flutter bootstrap ONLY if we should load the app -->
  <script>
    if (window.PWA_CONFIG.loadFlutter) {
      debugLog('=== Loading Flutter ===', 'warning');
      debugLog(`Base href: ${document.querySelector('base').href}`);
      
      // Show loading indicator
      document.getElementById('loading').classList.add('active');
      
      // Dynamically load flutter_bootstrap.js
      var script = document.createElement('script');
      script.src = 'flutter_bootstrap.js';
      script.async = true;
      
      script.onerror = function() {
        debugLog('‚úó FAILED to load flutter_bootstrap.js', 'error');
        debugLog(`Script src attempted: ${script.src}`, 'error');
        document.getElementById('loading').innerHTML = `
          <div style="padding:20px;font-family:sans-serif;text-align:center;">
            <h2 style="color:#dc3545;">‚ùå Failed to Load</h2>
            <p><strong>flutter_bootstrap.js not found</strong></p>
            <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin:16px 0;font-size:12px;text-align:left;">
              <div>Script: ${script.src}</div>
              <div>Base: ${document.querySelector('base').href}</div>
              <div>Location: ${window.location.href}</div>
            </div>
            <button onclick="location.reload()" style="margin-top:12px;padding:10px 20px;background:#0b6efd;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;">üîÑ Retry</button>
            <p style="font-size:12px;color:#666;margin-top:12px;">Tap üêõ Debug for more info</p>
          </div>
        `;
      };
      
      script.onload = function() {
        debugLog('‚úì flutter_bootstrap.js loaded successfully!', 'success');
      };
      
      debugLog('Appending flutter_bootstrap.js script tag');
      document.body.appendChild(script);
    } else {
      debugLog('Flutter bootstrap skipped - showing alternative UI', 'info');
    }
  </script>
</body>
</html>